# Docker ベストプラクティス

<!-- mtoc-start -->

* [ベースイメージの選定](#ベースイメージの選定)
  * [ビルドステージ（builder）](#ビルドステージbuilder)
  * [実行ステージ（runner）](#実行ステージrunner)
* [セキュリティ](#セキュリティ)
* [ビルドと構成管理](#ビルドと構成管理)
* [ビルドコンテキスト最適化](#ビルドコンテキスト最適化)
* [品質管理](#品質管理)

<!-- mtoc-end -->

## ベースイメージの選定

### ビルドステージ（builder）

* `golang:1.24-bookworm` を使用すること
* Bookworm (Debian 12) の選定理由
  * 2028年6月までセキュリティサポート提供
  * より最新のシステムライブラリとツールへのアクセス
  * システムコンポーネントの最適化による全体的なパフォーマンス向上

参考：

* <https://www.freexian.com/lts/extended/docs/debian-12-support/>
* <https://host-world.com/whats-new-in-debian-12-bookworm-release-new-features-and-improvements>

### 実行ステージ（runner）

* ベースイメージ
  * Google の Distroless イメージを使用すること
  * `gcr.io/distroless/static-debian12:nonroot` を標準とする
* 選定理由
  * Debian ベースで glibc との互換性が確保されている
  * Google による継続的なメンテナンスと脆弱性対応
  * 最小限のコンポーネントのみを含むため、攻撃対象領域が小さい
  * シェルやパッケージマネージャーを含まないため、セキュリティリスクを低減

参考：

* <https://github.com/GoogleContainerTools/distroless>
* <https://blog.inductor.me/entry/alpine-not-recommended>

補足：

* `:nonroot`タグを使用し、`USER`ディレクティブは指定しない
  * `:nonroot`タグを使用せず、`USER 65532`と指定しても非rootユーザーを使用できる
  * ただ、後者の定義が推奨されている情報はなく、かつ`:nonroot`タグを使用することでUID 65532で動くようになるため
  * タグ名自体が「非rootユーザー」という意図を明示しており、可読性が高い

## セキュリティ

* 非rootユーザーの使用
  * すべてのコンテナは非rootユーザーで実行すること
* 最小権限の原則
  * コンテナに付与する権限は必要最小限とすること
  * 特権的な設定は使用しないこと
* **イメージのセキュリティ**
  * ベースイメージは常に具体的なバージョンを指定すること（latest タグは使用禁止）
  * 定期的に `trivy` などでセキュリティスキャンを実施すること
  * 脆弱性が発見された場合は速やかに対応すること

## ビルドと構成管理

* **マルチステージビルド**
  * 本番用イメージはマルチステージビルドを使用すること
  * 最終イメージには必要最小限のパッケージのみを含めること
  * ビルドツールや開発用パッケージは本番イメージに含めないこと
* 環境変数の管理
  * 機密情報は Dockerfile 内に直接記述しないこと
  * 環境変数は `.env` ファイルまたはシークレット管理システムで管理すること
  * 環境ごとに適切な設定ファイルを用意すること
* ボリューム管理
  * 永続化が必要なデータは適切にボリュームを設定すること
  * 本番環境では読み取り専用（read-only）を基本とすること

## ビルドコンテキスト最適化

* .dockerignore の活用
  * イメージサイズとビルド時間を削減するため、ビルドコンテキストから不要なファイルを除外すること
* .dockerignore の重要性
  * ビルド時間短縮: 不要ファイルの転送時間を削減
  * ネットワーク使用量削減: CI/CD環境での効率化
  * セキュリティ向上: 機密ファイルの除外

## 品質管理

* Hadolintによる静的解析
  * Dockerfileのベストプラクティス違反を検出すること
  * 定期的に実行し、警告やエラーに対処すること
  * CI/CDパイプラインに組み込むことを推奨

参考：

* <https://github.com/hadolint/hadolint>
